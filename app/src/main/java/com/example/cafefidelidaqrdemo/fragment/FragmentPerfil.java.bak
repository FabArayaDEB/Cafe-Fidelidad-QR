package com.example.cafefidelidadqr.fragment;

import android.content.Context;
import android.content.Intent;
import android.os.Bundle;

import androidx.annotation.NonNull;
import androidx.fragment.app.Fragment;

import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;

import com.bumptech.glide.Glide;
import com.example.cafefidelidadqr.Contantes;
import com.example.cafefidelidadqr.EditarPerfilActivity;
import com.example.cafefidelidadqr.OpcionesLoginActivity;
import com.example.cafefidelidadqr.R;
import com.example.cafefidelidadqr.databinding.FragmentProfBinding;
import com.google.android.gms.auth.api.signin.GoogleSignIn;
import com.google.android.gms.auth.api.signin.GoogleSignInOptions;
import com.google.firebase.auth.FirebaseAuth;
import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseError;
import com.google.firebase.database.DatabaseReference;
import com.google.firebase.database.FirebaseDatabase;
import com.google.firebase.database.ValueEventListener;

public class FragmentPerfil extends Fragment {

    private FragmentProfBinding binding;
    private Context mContext;
    private FirebaseAuth firebaseAuth;

    public void onAttach(Context context) {
        mContext = context;
        super.onAttach(context);
    }

    public FragmentPerfil() {
        // Required empty public constructor
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        // Inflate the layout for this fragment
        binding = FragmentProfBinding.inflate(inflater, container, false);
        return binding.getRoot();
    }

    @Override
    public void onViewCreated(View view, Bundle savedInstanceState) {
        super.onViewCreated(view, savedInstanceState);

        firebaseAuth = FirebaseAuth.getInstance();

        binding.UpdateUserData.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                startActivity(new Intent(mContext, EditarPerfilActivity.class));
            }
        });

        // Cargar información del usuario en tiempo real
        loadUserInfo();
        
        binding.btnLogout.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                // Cerrar sesión de Firebase
                firebaseAuth.signOut();
                
                // Cerrar sesión de Google también
                GoogleSignIn.getClient(mContext, GoogleSignInOptions.DEFAULT_SIGN_IN).signOut();
                
                startActivity(new Intent(mContext, OpcionesLoginActivity.class));
                getActivity().finishAffinity();
            }
        });
    }

    private void loadUserInfo() {
        DatabaseReference ref = FirebaseDatabase.getInstance().getReference("Users");
        ref.child(firebaseAuth.getUid())
                .addValueEventListener(new ValueEventListener() {
                    @Override
                    public void onDataChange(@NonNull DataSnapshot snapshot) {
                        String nombres = "" + snapshot.child("names").getValue();
                        String email = "" + snapshot.child("email").getValue();
                        String proveedor = "" + snapshot.child("proveedor").getValue();
                        String registro = "" + snapshot.child("date").getValue();
                        String imagen = "" + snapshot.child("imagen").getValue();
                        
                        // Información específica del programa de fidelidad
                        String puntosStr = "" + snapshot.child("puntos").getValue();
                        String nivel = "" + snapshot.child("nivel").getValue();
                        String totalComprasStr = "" + snapshot.child("totalCompras").getValue();
                        String ultimaVisitaStr = "" + snapshot.child("ultimaVisita").getValue();

                        if (registro.equals("null")) {
                            registro = "0";
                        }
                        String date = Contantes.DateFormat(Long.parseLong(registro));
                        
                        // Procesar puntos y nivel
                        int puntos = 0;
                        try {
                            puntos = Integer.parseInt(puntosStr.equals("null") ? "0" : puntosStr);
                        } catch (NumberFormatException e) {
                            puntos = 0;
                        }
                        
                        double totalCompras = 0;
                        try {
                            totalCompras = Double.parseDouble(totalComprasStr.equals("null") ? "0" : totalComprasStr);
                        } catch (NumberFormatException e) {
                            totalCompras = 0;
                        }
                        
                        String ultimaVisita = "";
                        if (!ultimaVisitaStr.equals("null")) {
                            try {
                                ultimaVisita = Contantes.DateFormat(Long.parseLong(ultimaVisitaStr));
                            } catch (NumberFormatException e) {
                                ultimaVisita = "No disponible";
                            }
                        } else {
                            ultimaVisita = "No disponible";
                        }
                        
                        if (nivel.equals("null")) {
                            nivel = Contantes.calcularNivel(puntos);
                        }

                        // Establecer valores en la UI
                        binding.tvNombres.setText(nombres);
                        binding.tvEmail.setText(email);
                        binding.tvProveedor.setText(proveedor);
                        binding.tvRegistro.setText("Miembro desde: " + date);
                        
                        // Información del programa de fidelidad
                        if (binding.tvPuntos != null) {
                            binding.tvPuntos.setText("Puntos: " + puntos);
                        }
                        if (binding.tvNivel != null) {
                            binding.tvNivel.setText("Nivel: " + nivel);
                        }
                        if (binding.tvTotalCompras != null) {
                            binding.tvTotalCompras.setText("Total gastado: $" + String.format("%.2f", totalCompras));
                        }
                        if (binding.tvUltimaVisita != null) {
                            binding.tvUltimaVisita.setText("Última visita: " + ultimaVisita);
                        }
                        
                        // Mostrar puntos para siguiente nivel
                        if (binding.tvSiguienteNivel != null) {
                            int puntosParaSiguiente = Contantes.puntosParaSiguienteNivel(puntos);
                            if (puntosParaSiguiente > 0) {
                                binding.tvSiguienteNivel.setText("Faltan " + puntosParaSiguiente + " puntos para el siguiente nivel");
                            } else {
                                binding.tvSiguienteNivel.setText("¡Has alcanzado el nivel máximo!");
                            }
                        }

                        Glide.with(mContext)
                                .load(imagen)
                                .placeholder(R.drawable.ic_account)
                                .into(binding.itemPerfil);
                    }

                    @Override
                    public void onCancelled(@NonNull DatabaseError error) {
                        // Manejar error
                    }
                });
    }
}